# ============================================================
# Nginx 主配置文件
# ============================================================
#
# 作用：
#   Nginx 的全局配置
#
# 说明：
#   - 工作进程数
#   - 连接数限制
#   - 日志配置
#   - HTTP 基础配置

user nginx;
worker_processes auto;  # 自动根据 CPU 核心数设置进程数

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# ============================================================
# 事件配置
# ============================================================

events {
    worker_connections 1024;  # 每个进程最大连接数
    use epoll;  # Linux 下使用 epoll（高效的 IO 多路复用）
}

# ============================================================
# HTTP 配置
# ============================================================

http {
    # ----------------------------------------------------------
    # 基础配置
    # ----------------------------------------------------------

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # ----------------------------------------------------------
    # 性能优化
    # ----------------------------------------------------------

    sendfile on;  # 高效文件传输
    tcp_nopush on;  # 优化 TCP 包传输
    tcp_nodelay on;  # 禁用 Nagle 算法

    keepalive_timeout 65;  # 长连接超时时间

    types_hash_max_size 2048;

    # 隐藏 Nginx 版本号（安全性）
    server_tokens off;

    # ----------------------------------------------------------
    # Gzip 压缩
    # ----------------------------------------------------------

    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # ----------------------------------------------------------
    # 缓冲区配置
    # ----------------------------------------------------------

    client_body_buffer_size 128k;
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    output_buffers 1 32k;
    postpone_output 1460;

    # ----------------------------------------------------------
    # 超时配置
    # ----------------------------------------------------------

    client_header_timeout 3m;
    client_body_timeout 3m;
    send_timeout 3m;

    # ----------------------------------------------------------
    # 包含站点配置
    # ----------------------------------------------------------

    include /etc/nginx/conf.d/*.conf;
}


# ============================================================
# 学习笔记
# ============================================================

# 1. 【核心指令说明】
#
#    worker_processes:
#    - auto: 自动检测 CPU 核心数
#    - 数字: 手动指定进程数（通常等于 CPU 核心数）
#
#    worker_connections:
#    - 每个 worker 进程的最大连接数
#    - 理论最大并发: worker_processes × worker_connections
#
#    sendfile:
#    - 开启高效文件传输模式
#    - 减少文件在用户空间和内核空间的拷贝
#
#    gzip:
#    - 压缩响应内容
#    - 减少传输数据量
#    - 提高响应速度

# 2. 【日志配置】
#
#    access_log: 访问日志
#    - 记录所有请求
#    - 用于分析流量
#
#    error_log: 错误日志
#    - 记录错误信息
#    - 用于排查问题
#
#    日志级别（从低到高）：
#    - debug
#    - info
#    - notice
#    - warn
#    - error
#    - crit

# 3. 【性能优化】
#
#    tcp_nopush + tcp_nodelay:
#    - 优化网络传输
#    - 减少延迟
#
#    keepalive_timeout:
#    - 保持连接时间
#    - 减少 TCP 握手开销
#
#    gzip:
#    - 压缩文本内容
#    - 不压缩图片（已经压缩）

# 4. 【安全配置】
#
#    server_tokens off:
#    - 隐藏 Nginx 版本号
#    - 防止针对特定版本的攻击
#
#    client_max_body_size:
#    - 限制上传文件大小
#    - 防止恶意上传

# 5. 【配置文件结构】
#
#    nginx.conf: 主配置（全局）
#    ├── http 块
#    │   ├── server 块（虚拟主机）
#    │   │   └── location 块（路由）
#    └── include conf.d/*.conf（站点配置）
