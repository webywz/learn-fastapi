# ============================================================
# FastAPI 应用站点配置
# ============================================================
#
# 作用：
#   配置反向代理，将请求转发到 FastAPI 应用
#
# 功能：
#   - HTTP 反向代理
#   - 负载均衡（可选）
#   - 静态文件服务
#   - HTTPS 配置（可选）

# ============================================================
# Upstream 配置（后端服务器组）
# ============================================================

upstream fastapi_backend {
    # FastAPI 应用服务器
    server app:8080;

    # 负载均衡策略（单机可不配置）
    # least_conn;  # 最少连接数
    # ip_hash;     # IP 哈希（会话保持）

    # 多实例示例：
    # server app1:8080 weight=3;  # 权重
    # server app2:8080 weight=1;
    # server app3:8080 backup;    # 备用服务器
}

# ============================================================
# HTTP 服务器配置（端口 80）
# ============================================================

server {
    listen 80;
    server_name localhost;

    # 字符集
    charset utf-8;

    # 访问日志
    access_log /var/log/nginx/fastapi_access.log;
    error_log /var/log/nginx/fastapi_error.log;

    # ----------------------------------------------------------
    # API 请求代理（转发到 FastAPI）
    # ----------------------------------------------------------

    location /api/ {
        # 代理到后端
        proxy_pass http://fastapi_backend;

        # 代理请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 缓冲配置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # ----------------------------------------------------------
    # WebSocket 支持（如果需要）
    # ----------------------------------------------------------

    location /ws/ {
        proxy_pass http://fastapi_backend;

        # WebSocket 必须的配置
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # WebSocket 超时（保持长连接）
        proxy_read_timeout 86400;
    }

    # ----------------------------------------------------------
    # API 文档（Swagger UI 和 ReDoc）
    # ----------------------------------------------------------

    location /docs {
        proxy_pass http://fastapi_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /redoc {
        proxy_pass http://fastapi_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /openapi.json {
        proxy_pass http://fastapi_backend;
        proxy_set_header Host $host;
    }

    # ----------------------------------------------------------
    # 根路径（健康检查）
    # ----------------------------------------------------------

    location / {
        proxy_pass http://fastapi_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ----------------------------------------------------------
    # 静态文件（如果有）
    # ----------------------------------------------------------

    # location /static/ {
    #     alias /app/static/;
    #     expires 30d;
    #     add_header Cache-Control "public, immutable";
    # }

    # ----------------------------------------------------------
    # 错误页面
    # ----------------------------------------------------------

    error_page 404 /404.html;
    location = /404.html {
        internal;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        internal;
    }

    # ----------------------------------------------------------
    # 限流配置（防止 DDoS）
    # ----------------------------------------------------------

    # limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    # location /api/ {
    #     limit_req zone=api_limit burst=20 nodelay;
    #     proxy_pass http://fastapi_backend;
    # }
}

# ============================================================
# HTTPS 服务器配置（端口 443）
# ============================================================

# 如果需要 HTTPS，取消注释以下配置
# server {
#     listen 443 ssl http2;
#     server_name yourdomain.com;
#
#     # SSL 证书
#     ssl_certificate /etc/nginx/ssl/cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/key.pem;
#
#     # SSL 配置
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#
#     # HSTS（强制 HTTPS）
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#
#     # 其他配置与 HTTP 服务器相同
#     location /api/ {
#         proxy_pass http://fastapi_backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;
#     }
#
#     location / {
#         proxy_pass http://fastapi_backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#     }
# }

# ============================================================
# HTTP 重定向到 HTTPS（如果启用 HTTPS）
# ============================================================

# server {
#     listen 80;
#     server_name yourdomain.com;
#
#     # 重定向所有 HTTP 请求到 HTTPS
#     return 301 https://$server_name$request_uri;
# }


# ============================================================
# 学习笔记
# ============================================================

# 1. 【Upstream（上游服务器）】
#
#    定义后端服务器组：
#    upstream backend {
#        server app1:8080;
#        server app2:8080;
#    }
#
#    负载均衡策略：
#    - 轮询（默认）: 依次分配请求
#    - least_conn: 分配到连接数最少的服务器
#    - ip_hash: 同一 IP 总是访问同一服务器

# 2. 【Location 匹配规则】
#
#    优先级（从高到低）：
#    1. = 精确匹配: location = /api/users
#    2. ^~ 前缀匹配: location ^~ /api/
#    3. ~ 正则匹配（区分大小写）: location ~ \.php$
#    4. ~* 正则匹配（不区分大小写）: location ~* \.(jpg|png)$
#    5. / 通用匹配: location /
#
#    示例：
#    location = /api/users { }  # 只匹配 /api/users
#    location /api/ { }         # 匹配 /api/* 所有路径

# 3. 【Proxy 指令说明】
#
#    proxy_pass:
#    - 转发请求到后端
#    - http://backend 会保留 URI
#    - http://backend/ 会替换 URI
#
#    proxy_set_header:
#    - 设置转发到后端的请求头
#    - Host: 原始请求的 Host
#    - X-Real-IP: 客户端真实 IP
#    - X-Forwarded-For: 代理链路中的所有 IP
#    - X-Forwarded-Proto: 原始协议（http/https）

# 4. 【WebSocket 配置】
#
#    必须配置：
#    - proxy_http_version 1.1
#    - proxy_set_header Upgrade $http_upgrade
#    - proxy_set_header Connection "upgrade"
#
#    这些配置让 Nginx 支持 WebSocket 协议升级

# 5. 【缓存配置】
#
#    静态文件缓存：
#    location /static/ {
#        expires 30d;  # 缓存 30 天
#        add_header Cache-Control "public, immutable";
#    }
#
#    API 响应缓存（慎用）：
#    proxy_cache_path /path/to/cache levels=1:2 keys_zone=api_cache:10m;
#    proxy_cache api_cache;
#    proxy_cache_valid 200 10m;

# 6. 【限流（Rate Limiting）】
#
#    定义限流区域：
#    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
#
#    应用限流：
#    location /api/ {
#        limit_req zone=api_limit burst=20 nodelay;
#    }
#
#    说明：
#    - rate=10r/s: 每秒最多 10 个请求
#    - burst=20: 允许突发 20 个请求
#    - nodelay: 不延迟处理突发请求

# 7. 【HTTPS 配置】
#
#    需要：
#    1. SSL 证书文件（cert.pem）
#    2. 私钥文件（key.pem）
#
#    获取证书：
#    - Let's Encrypt（免费）
#    - 购买商业证书
#    - 自签名证书（开发用）
#
#    自签名证书生成：
#    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#        -keyout key.pem -out cert.pem

# 8. 【常见错误码】
#
#    502 Bad Gateway:
#    - 后端服务未启动
#    - 后端服务地址错误
#
#    504 Gateway Timeout:
#    - 后端响应超时
#    - 增加 proxy_read_timeout
#
#    413 Request Entity Too Large:
#    - 上传文件过大
#    - 增加 client_max_body_size
