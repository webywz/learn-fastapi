"""
===========================================
Celery åº”ç”¨é…ç½® (Celery Application)
===========================================

ä½œç”¨ï¼š
  é…ç½®å’Œåˆ›å»º Celery åº”ç”¨å®ä¾‹

ä»€ä¹ˆæ˜¯ Celeryï¼Ÿ
  - åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—
  - ç”¨äºå¤„ç†å¼‚æ­¥ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡
  - ç±»ä¼¼å‰ç«¯çš„ Web Workerï¼Œä½†åœ¨æœåŠ¡å™¨ç«¯

ä¸ºä»€ä¹ˆéœ€è¦ Celeryï¼Ÿ
  1. å¤„ç†è€—æ—¶ä»»åŠ¡ï¼ˆä¸é˜»å¡ API å“åº”ï¼‰
  2. å®šæ—¶ä»»åŠ¡ï¼ˆå®šæœŸæ¸…ç†ã€ç»Ÿè®¡ï¼‰
  3. å¹¶å‘å¤„ç†ï¼ˆæ‰¹é‡ä»»åŠ¡ï¼‰
  4. ä»»åŠ¡é‡è¯•ï¼ˆå¤±è´¥è‡ªåŠ¨é‡è¯•ï¼‰

ç±»æ¯”å‰ç«¯ï¼š
  - ç±»ä¼¼ setTimeout/setInterval
  - ä½†æ›´å¼ºå¤§ï¼šåˆ†å¸ƒå¼ã€å¯ç›‘æ§ã€è‡ªåŠ¨é‡è¯•

æ¶æ„ï¼š
  FastAPI â†’ å‘é€ä»»åŠ¡ â†’ Redis (Broker) â†’ Celery Worker â†’ æ‰§è¡Œä»»åŠ¡ â†’ Redis (Backend) â†’ å­˜å‚¨ç»“æœ
"""

from celery import Celery
from celery.schedules import crontab
from core.config import settings


# ============================================================
# åˆ›å»º Celery åº”ç”¨å®ä¾‹
# ============================================================

celery_app = Celery(
    "fastapi_tasks",  # åº”ç”¨åç§°
    broker=settings.CELERY_BROKER,  # æ¶ˆæ¯ä»£ç†ï¼ˆRedisï¼‰
    backend=settings.CELERY_BACKEND,  # ç»“æœå­˜å‚¨ï¼ˆRedisï¼‰
    include=[
        "tasks.email_tasks",      # é‚®ä»¶ä»»åŠ¡
        "tasks.report_tasks",     # æŠ¥è¡¨ä»»åŠ¡
        "tasks.cleanup_tasks",    # æ¸…ç†ä»»åŠ¡
    ]
)
"""
Celery åº”ç”¨å®ä¾‹

å‚æ•°è¯´æ˜:
  - broker: æ¶ˆæ¯ä»£ç†ï¼Œå­˜å‚¨å¾…æ‰§è¡Œçš„ä»»åŠ¡
  - backend: ç»“æœåç«¯ï¼Œå­˜å‚¨ä»»åŠ¡æ‰§è¡Œç»“æœ
  - include: è‡ªåŠ¨å¯¼å…¥çš„ä»»åŠ¡æ¨¡å—åˆ—è¡¨

ä¸ºä»€ä¹ˆéœ€è¦ Broker å’Œ Backendï¼Ÿ
  - Broker: å­˜å‚¨ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¾…åŠäº‹é¡¹åˆ—è¡¨ï¼‰
  - Backend: å­˜å‚¨ä»»åŠ¡ç»“æœï¼ˆæ‰§è¡Œç»“æœè®°å½•ï¼‰

  å°±åƒï¼š
    Broker = å¾…åŠäº‹é¡¹ App
    Backend = å®Œæˆè®°å½• App
"""


# ============================================================
# Celery é…ç½®
# ============================================================

celery_app.conf.update(
    # =========================================
    # ä»»åŠ¡é…ç½®
    # =========================================

    # ä»»åŠ¡åºåˆ—åŒ–æ ¼å¼
    # æ”¯æŒçš„æ ¼å¼: json, pickle, yaml, msgpack
    # æ¨è jsonï¼ˆå®‰å…¨ã€å…¼å®¹æ€§å¥½ï¼‰
    task_serializer="json",

    # æ¥å—çš„å†…å®¹ç±»å‹
    # å®‰å…¨èµ·è§ï¼Œåªæ¥å— json
    accept_content=["json"],

    # ç»“æœåºåˆ—åŒ–æ ¼å¼
    result_serializer="json",

    # æ—¶åŒºè®¾ç½®
    # å½±å“å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
    timezone="Asia/Shanghai",

    # æ˜¯å¦ä½¿ç”¨ UTC æ—¶é—´
    # False: ä½¿ç”¨æœ¬åœ°æ—¶åŒº
    # True: ä½¿ç”¨ UTCï¼ˆå¦‚æœæœåŠ¡å™¨åœ¨å›½å¤–ï¼‰
    enable_utc=False,

    # =========================================
    # ä»»åŠ¡æ‰§è¡Œé…ç½®
    # =========================================

    # ä»»åŠ¡ç¡®è®¤æ—¶æœº
    # True: ä»»åŠ¡æ‰§è¡Œå®Œæˆåç¡®è®¤ï¼ˆæ¨èï¼‰
    # False: ä»»åŠ¡æ¥æ”¶åç«‹å³ç¡®è®¤
    # å¥½å¤„ï¼š
    # - ä»»åŠ¡æ‰§è¡Œå¤±è´¥ä¸ä¼šä¸¢å¤±
    # - Worker å´©æºƒåä»»åŠ¡å¯ä»¥é‡æ–°æ‰§è¡Œ
    task_acks_late=True,

    # Worker ä¸¢å¤±æ—¶æ˜¯å¦æ‹’ç»ä»»åŠ¡
    # True: Worker å¼‚å¸¸é€€å‡ºæ—¶ï¼Œä»»åŠ¡é‡æ–°å…¥é˜Ÿ
    # False: ä»»åŠ¡ä¸¢å¤±
    task_reject_on_worker_lost=True,

    # Worker é¢„å–ä»»åŠ¡æ•°é‡
    # 1: æ¯æ¬¡åªå– 1 ä¸ªä»»åŠ¡ï¼ˆå…¬å¹³åˆ†é…ï¼‰
    # 4: æ¯æ¬¡å– 4 ä¸ªä»»åŠ¡ï¼ˆæé«˜ååé‡ï¼‰
    # å»ºè®®ï¼š
    # - é•¿ä»»åŠ¡: 1ï¼ˆé¿å…é˜»å¡ï¼‰
    # - çŸ­ä»»åŠ¡: 4-8ï¼ˆæé«˜æ•ˆç‡ï¼‰
    worker_prefetch_multiplier=1,

    # ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    # è¶…è¿‡æ­¤æ—¶é—´ï¼Œä»»åŠ¡è¢«å¼ºåˆ¶ç»ˆæ­¢
    # 3600 ç§’ = 1 å°æ—¶
    # é˜²æ­¢ä»»åŠ¡å¡æ­»å ç”¨ Worker
    task_time_limit=3600,

    # ä»»åŠ¡è½¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    # è¶…è¿‡æ­¤æ—¶é—´ï¼ŒæŠ›å‡º SoftTimeLimitExceeded å¼‚å¸¸
    # ç»™ä»»åŠ¡ä¸€ä¸ªæ¸…ç†çš„æœºä¼š
    # 3000 ç§’ = 50 åˆ†é’Ÿ
    task_soft_time_limit=3000,

    # =========================================
    # ç»“æœé…ç½®
    # =========================================

    # ä»»åŠ¡ç»“æœè¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
    # ç»“æœåœ¨ Redis ä¸­ä¿ç•™çš„æ—¶é—´
    # 3600 ç§’ = 1 å°æ—¶
    # è¿‡æœŸåè‡ªåŠ¨åˆ é™¤ï¼ˆèŠ‚çœå†…å­˜ï¼‰
    result_expires=3600,

    # ç»“æœåç«¯ä¼ è¾“é€‰é¡¹ï¼ˆRedis å“¨å…µæ¨¡å¼ç”¨ï¼‰
    result_backend_transport_options={
        "master_name": "mymaster",
    },

    # =========================================
    # è·¯ç”±é…ç½®ï¼ˆé«˜çº§ï¼‰
    # =========================================

    # ä»»åŠ¡è·¯ç”±é…ç½®
    # å°†ä¸åŒç±»å‹çš„ä»»åŠ¡åˆ†é…åˆ°ä¸åŒçš„é˜Ÿåˆ—
    # å¥½å¤„ï¼š
    # - ä¼˜å…ˆçº§æ§åˆ¶ï¼ˆé‡è¦ä»»åŠ¡ä¼˜å…ˆï¼‰
    # - èµ„æºéš”ç¦»ï¼ˆé‚®ä»¶ä»»åŠ¡ä¸å½±å“æŠ¥è¡¨ï¼‰
    # - ç‹¬ç«‹æ‰©å±•ï¼ˆé‚®ä»¶ Worker ç‹¬ç«‹æ‰©å±•ï¼‰
    # ä½¿ç”¨ï¼š
    # celery -A core.celery_app worker -Q email  # åªå¤„ç†é‚®ä»¶é˜Ÿåˆ—
    # celery -A core.celery_app worker -Q report # åªå¤„ç†æŠ¥è¡¨é˜Ÿåˆ—
    task_routes={
        "tasks.email_tasks.*": {"queue": "email"},
        "tasks.report_tasks.*": {"queue": "report"},
        "tasks.cleanup_tasks.*": {"queue": "cleanup"},
    },

    # =========================================
    # å®šæ—¶ä»»åŠ¡é…ç½®
    # =========================================

    # å®šæ—¶ä»»åŠ¡é…ç½®ï¼ˆBeat Scheduleï¼‰
    # å®šæ—¶ä»»åŠ¡ç±»ä¼¼ Linux çš„ cron
    # schedule æ ¼å¼:
    # - crontab(hour=2, minute=0)  # æ¯å¤© 2:00
    # - crontab(hour=0, minute=0, day_of_week=1)  # æ¯å‘¨ä¸€ 0:00
    # - crontab(minute="*/15")  # æ¯ 15 åˆ†é’Ÿ
    # - 600.0  # æ¯ 600 ç§’
    # éœ€è¦å¯åŠ¨ Beat è¿›ç¨‹ï¼š
    # celery -A core.celery_app beat
    beat_schedule={
        # æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ¸…ç†è¿‡æœŸæ•°æ®
        "cleanup-expired-data": {
            "task": "tasks.cleanup_tasks.cleanup_expired_data",
            "schedule": crontab(hour=2, minute=0),
        },

        # æ¯å°æ—¶ç”Ÿæˆç»Ÿè®¡æŠ¥è¡¨
        "generate-hourly-report": {
            "task": "tasks.report_tasks.generate_hourly_report",
            "schedule": crontab(minute=0),  # æ¯å°æ—¶çš„ 0 åˆ†
        },

        # æ¯ 10 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        "health-check": {
            "task": "tasks.cleanup_tasks.health_check",
            "schedule": 600.0,  # 600 ç§’ = 10 åˆ†é’Ÿ
        },
    },
)


# ============================================================
# ä»»åŠ¡åŸºç±»é…ç½®
# ============================================================

class BaseTask(celery_app.Task):
    """
    è‡ªå®šä¹‰ä»»åŠ¡åŸºç±»

    å¯ä»¥æ·»åŠ é€šç”¨çš„ä»»åŠ¡è¡Œä¸º

    ç¤ºä¾‹ï¼š
    - ä»»åŠ¡å¼€å§‹/ç»“æŸæ—¶è®°å½•æ—¥å¿—
    - ä»»åŠ¡å¤±è´¥æ—¶å‘é€é€šçŸ¥
    - ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œæ—¶é—´
    """

    def on_success(self, retval, task_id, args, kwargs):
        """
        ä»»åŠ¡æˆåŠŸæ—¶è°ƒç”¨

        å‚æ•°:
            retval: ä»»åŠ¡è¿”å›å€¼
            task_id: ä»»åŠ¡ ID
            args: ä»»åŠ¡å‚æ•°
            kwargs: ä»»åŠ¡å…³é”®å­—å‚æ•°
        """
        print(f"âœ… ä»»åŠ¡æˆåŠŸ: {self.name} (ID: {task_id})")

    def on_failure(self, exc, task_id, args, kwargs, einfo):
        """
        ä»»åŠ¡å¤±è´¥æ—¶è°ƒç”¨

        å‚æ•°:
            exc: å¼‚å¸¸å¯¹è±¡
            task_id: ä»»åŠ¡ ID
            args: ä»»åŠ¡å‚æ•°
            kwargs: ä»»åŠ¡å…³é”®å­—å‚æ•°
            einfo: å¼‚å¸¸ä¿¡æ¯
        """
        print(f"âŒ ä»»åŠ¡å¤±è´¥: {self.name} (ID: {task_id})")
        print(f"   é”™è¯¯: {exc}")

    def on_retry(self, exc, task_id, args, kwargs, einfo):
        """
        ä»»åŠ¡é‡è¯•æ—¶è°ƒç”¨

        å‚æ•°:
            exc: å¼‚å¸¸å¯¹è±¡
            task_id: ä»»åŠ¡ ID
            args: ä»»åŠ¡å‚æ•°
            kwargs: ä»»åŠ¡å…³é”®å­—å‚æ•°
            einfo: å¼‚å¸¸ä¿¡æ¯
        """
        print(f"ğŸ”„ ä»»åŠ¡é‡è¯•: {self.name} (ID: {task_id})")


# è®¾ç½®é»˜è®¤ä»»åŠ¡åŸºç±»
celery_app.Task = BaseTask


# ============================================================
# å­¦ä¹ ç¬”è®°
# ============================================================
"""
å…³é”®æ¦‚å¿µæ€»ç»“ï¼š

1. ã€Celery æ ¸å¿ƒç»„ä»¶ã€‘
   - Celery App: åº”ç”¨å®ä¾‹
   - Worker: æ‰§è¡Œä»»åŠ¡çš„è¿›ç¨‹
   - Beat: å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
   - Broker: æ¶ˆæ¯ä»£ç†ï¼ˆå­˜å‚¨ä»»åŠ¡é˜Ÿåˆ—ï¼‰
   - Backend: ç»“æœå­˜å‚¨ï¼ˆå­˜å‚¨ä»»åŠ¡ç»“æœï¼‰

2. ã€ä»»åŠ¡é˜Ÿåˆ—æµç¨‹ã€‘
   1. FastAPI å‘é€ä»»åŠ¡ â†’ Broker (Redis)
   2. Worker ä» Broker è·å–ä»»åŠ¡
   3. Worker æ‰§è¡Œä»»åŠ¡
   4. ç»“æœå­˜å‚¨åˆ° Backend (Redis)
   5. FastAPI ä» Backend è·å–ç»“æœ

3. ã€å¯åŠ¨ Celeryã€‘
   # å¯åŠ¨ Workerï¼ˆæ‰§è¡Œä»»åŠ¡ï¼‰
   celery -A core.celery_app worker --loglevel=info

   # å¯åŠ¨ Beatï¼ˆå®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼‰
   celery -A core.celery_app beat --loglevel=info

   # å¯åŠ¨ Flowerï¼ˆWeb ç›‘æ§ï¼‰
   celery -A core.celery_app flower

4. ã€é˜Ÿåˆ— vs æ™®é€šå‡½æ•°ã€‘
   æ™®é€šå‡½æ•°:
   - åŒæ­¥æ‰§è¡Œï¼Œé˜»å¡ API
   - ä»»åŠ¡å¤±è´¥æ— æ³•é‡è¯•
   - æ— æ³•ç›‘æ§

   Celery ä»»åŠ¡:
   - å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ API
   - è‡ªåŠ¨é‡è¯•
   - å¯ç›‘æ§ã€å¯æ‰©å±•

5. ã€ä½¿ç”¨åœºæ™¯ã€‘
   - å‘é€é‚®ä»¶ï¼ˆè€—æ—¶ 1-2 ç§’ï¼‰
   - ç”ŸæˆæŠ¥è¡¨ï¼ˆè€—æ—¶æ•°åˆ†é’Ÿï¼‰
   - å›¾ç‰‡å¤„ç†ï¼ˆè€—æ—¶æ•°ç§’ï¼‰
   - æ•°æ®å¯¼å…¥/å¯¼å‡º
   - å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©ç»Ÿè®¡ï¼‰
"""
