# ğŸ“ FastAPI åç«¯å¼€å‘å®Œæ•´æ•™ç¨‹

> ä¸“ä¸ºå‰ç«¯å¼€å‘è€…æ‰“é€ çš„åç«¯å­¦ä¹ é¡¹ç›®

è¿™æ˜¯ä¸€ä¸ªä»é›¶å¼€å§‹çš„ FastAPI åç«¯æ•™å­¦é¡¹ç›®ï¼Œæ¶µç›–äº†åç«¯å¼€å‘çš„æ‰€æœ‰æ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚æ‰€æœ‰ä»£ç éƒ½æœ‰è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼Œå¸®åŠ©ä½ å¿«é€ŸæŒæ¡ Python Web å¼€å‘ã€‚

---

## ğŸ“š é¡¹ç›®ç‰¹è‰²

âœ… **è¯¦ç»†æ³¨é‡Š**ï¼šæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰å¤§é‡æ³¨é‡Šï¼Œè§£é‡Š"ä¸ºä»€ä¹ˆ"è€Œä¸åªæ˜¯"æ€ä¹ˆåš"
âœ… **å®Œæ•´æ¶æ„**ï¼šç»Ÿä¸€å“åº”æ ¼å¼ã€é”™è¯¯ç ã€å¼‚å¸¸å¤„ç†ã€æ—¥å¿—ç³»ç»Ÿ
âœ… **æœ€ä½³å®è·µ**ï¼šéµå¾ªå·¥ä¸šæ ‡å‡†çš„é¡¹ç›®ç»“æ„å’Œä»£ç è§„èŒƒ
âœ… **å‰ç«¯å‹å¥½**ï¼šä»å‰ç«¯è§†è§’è§£é‡Šåç«¯æ¦‚å¿µï¼Œæ˜“äºç†è§£
âœ… **å®æˆ˜å¯¼å‘**ï¼šå¯ç›´æ¥ç”¨äºçœŸå®é¡¹ç›®

---

## ğŸ¯ ä½ å°†å­¦åˆ°

### 1ï¸âƒ£ æ ¸å¿ƒæ¦‚å¿µ
- ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆResponse Schemaï¼‰
- é”™è¯¯ç ä½“ç³»ï¼ˆError Codesï¼‰
- è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ï¼ˆCustom Exceptionsï¼‰
- å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼ˆGlobal Exception Handlerï¼‰

### 2ï¸âƒ£ æ•°æ®åº“
- SQLAlchemy ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰
- å¼‚æ­¥æ•°æ®åº“æ“ä½œ
- æ•°æ®åº“è¿ç§»ï¼ˆAlembicï¼‰
- è¿æ¥æ± ç®¡ç†

### 3ï¸âƒ£ å®‰å…¨
- å¯†ç åŠ å¯†ï¼ˆbcryptï¼‰
- JWT è®¤è¯
- ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰
- æƒé™æ§åˆ¶

### 4ï¸âƒ£ ä¸­é—´ä»¶
- è¯·æ±‚æ—¥å¿—è®°å½•
- CORS è·¨åŸŸå¤„ç†
- å¼‚å¸¸ç»Ÿä¸€å¤„ç†

### 5ï¸âƒ£ API å¼€å‘
- RESTful API è®¾è®¡
- Pydantic æ•°æ®éªŒè¯
- è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£
- åˆ†é¡µã€æœç´¢ã€è¿‡æ»¤

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
backend-tutorial/
â”œâ”€â”€ common/                  # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ response.py         # ç»Ÿä¸€å“åº”æ ¼å¼ â­
â”‚   â”œâ”€â”€ error_codes.py      # é”™è¯¯ç å®šä¹‰ â­
â”‚   â””â”€â”€ exceptions.py       # è‡ªå®šä¹‰å¼‚å¸¸ â­
â”œâ”€â”€ core/                    # æ ¸å¿ƒé…ç½®
â”‚   â”œâ”€â”€ config.py           # é…ç½®æ–‡ä»¶ â­
â”‚   â”œâ”€â”€ database.py         # æ•°æ®åº“é…ç½® â­
â”‚   â””â”€â”€ security.py         # å®‰å…¨æ¨¡å—ï¼ˆå¯†ç ã€JWTï¼‰â­
â”œâ”€â”€ middleware/              # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ logger.py           # è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ â­
â”‚   â””â”€â”€ error_handler.py    # å…¨å±€å¼‚å¸¸å¤„ç†å™¨ â­
â”œâ”€â”€ models/                  # æ•°æ®åº“æ¨¡å‹ï¼ˆORMï¼‰
â”‚   â””â”€â”€ user.py             # ç”¨æˆ·æ¨¡å‹ â­
â”œâ”€â”€ schemas/                 # Pydantic æ¨¡å‹ï¼ˆAPI æ•°æ®æ ¼å¼ï¼‰
â”‚   â””â”€â”€ user.py             # ç”¨æˆ· Schema â­
â”œâ”€â”€ api/                     # API è·¯ç”±
â”‚   â”œâ”€â”€ deps.py             # ä¾èµ–æ³¨å…¥ â­
â”‚   â””â”€â”€ v1/
â”‚       â”œâ”€â”€ auth.py         # è®¤è¯æ¥å£ï¼ˆæ³¨å†Œã€ç™»å½•ï¼‰â­
â”‚       â””â”€â”€ users.py        # ç”¨æˆ·æ¥å£ â­
â”œâ”€â”€ services/                # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â””â”€â”€ user_service.py     # ç”¨æˆ·æœåŠ¡ â­
â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ logger.py           # æ—¥å¿—é…ç½® â­
â”œâ”€â”€ logs/                    # æ—¥å¿—æ–‡ä»¶ç›®å½•
â”œâ”€â”€ main.py                  # åº”ç”¨å…¥å£ â­
â”œâ”€â”€ requirements.txt         # Python ä¾èµ–
â”œâ”€â”€ .env.example            # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ README.md               # é¡¹ç›®æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰

â­ = åŒ…å«è¯¦ç»†æ³¨é‡Šå’Œå­¦ä¹ ç¬”è®°çš„æ ¸å¿ƒæ–‡ä»¶
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†æˆ–è¿›å…¥é¡¹ç›®

```bash
cd backend-tutorial
```

### 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/macOS
python3 -m venv venv
source venv/bin/activate
```

### 3. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 4. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œä¿®æ”¹é…ç½®
# ç‰¹åˆ«æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ SECRET_KEYï¼
```

### 5. è¿è¡Œé¡¹ç›®

```bash
python main.py
```

æˆ–è€…ä½¿ç”¨ uvicornï¼š

```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 6. è®¿é—® API æ–‡æ¡£

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

---

## ğŸ“– API ä½¿ç”¨ç¤ºä¾‹

### 1. ç”¨æˆ·æ³¨å†Œ

```bash
POST http://localhost:8000/api/v1/auth/register
Content-Type: application/json

{
  "username": "alice",
  "email": "alice@example.com",
  "password": "123456"
}
```

**å“åº”ï¼š**
```json
{
  "code": 0,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "id": 1,
    "username": "alice",
    "email": "alice@example.com",
    "is_active": true,
    "is_superuser": false,
    "created_at": "2024-01-01T12:00:00",
    "updated_at": "2024-01-01T12:00:00"
  }
}
```

### 2. ç”¨æˆ·ç™»å½•

```bash
POST http://localhost:8000/api/v1/auth/login
Content-Type: application/json

{
  "username": "alice",
  "password": "123456"
}
```

**å“åº”ï¼š**
```json
{
  "code": 0,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer"
  }
}
```

### 3. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ç™»å½•ï¼‰

```bash
GET http://localhost:8000/api/v1/users/me
Authorization: Bearer <token>
```

**å“åº”ï¼š**
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1,
    "username": "alice",
    "email": "alice@example.com",
    ...
  }
}
```

---

## ğŸ¯ å­¦ä¹ è·¯å¾„

### ç¬¬ä¸€æ­¥ï¼šç†è§£ç»Ÿä¸€å“åº”æ ¼å¼

é˜…è¯»æ–‡ä»¶ï¼š`common/response.py`

**å…³é”®æ¦‚å¿µï¼š**
- ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€å“åº”æ ¼å¼ï¼Ÿ
- æˆåŠŸå’Œå¤±è´¥çš„å“åº”ç»“æ„
- åˆ†é¡µæ•°æ®çš„å¤„ç†

### ç¬¬äºŒæ­¥ï¼šæŒæ¡é”™è¯¯ç ä½“ç³»

é˜…è¯»æ–‡ä»¶ï¼š`common/error_codes.py`, `common/exceptions.py`

**å…³é”®æ¦‚å¿µï¼š**
- HTTP çŠ¶æ€ç  vs ä¸šåŠ¡é”™è¯¯ç 
- å¦‚ä½•è®¾è®¡é”™è¯¯ç 
- è‡ªå®šä¹‰å¼‚å¸¸ç±»

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®å’Œæ•°æ®åº“

é˜…è¯»æ–‡ä»¶ï¼š`core/config.py`, `core/database.py`

**å…³é”®æ¦‚å¿µï¼š**
- ç¯å¢ƒå˜é‡ç®¡ç†
- æ•°æ®åº“è¿æ¥æ± 
- ORM åŸºç¡€

### ç¬¬å››æ­¥ï¼šå®‰å…¨è®¤è¯

é˜…è¯»æ–‡ä»¶ï¼š`core/security.py`, `api/deps.py`

**å…³é”®æ¦‚å¿µï¼š**
- å¯†ç åŠ å¯†ï¼ˆä¸å¯é€†ï¼‰
- JWT å·¥ä½œåŸç†
- ä¾èµ–æ³¨å…¥

### ç¬¬äº”æ­¥ï¼šä¸­é—´ä»¶å’Œæ—¥å¿—

é˜…è¯»æ–‡ä»¶ï¼š`middleware/`, `utils/logger.py`

**å…³é”®æ¦‚å¿µï¼š**
- ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº
- è¯·æ±‚è¿½è¸ª
- æ—¥å¿—åˆ†çº§

### ç¬¬å…­æ­¥ï¼šæ•°æ®æ¨¡å‹

é˜…è¯»æ–‡ä»¶ï¼š`models/user.py`, `schemas/user.py`

**å…³é”®æ¦‚å¿µï¼š**
- ORM æ¨¡å‹ vs Pydantic æ¨¡å‹
- æ•°æ®åº“å­—æ®µç±»å‹
- æ•°æ®éªŒè¯

### ç¬¬ä¸ƒæ­¥ï¼šä¸šåŠ¡é€»è¾‘å’Œ API

é˜…è¯»æ–‡ä»¶ï¼š`services/`, `api/v1/`

**å…³é”®æ¦‚å¿µï¼š**
- åˆ†å±‚æ¶æ„
- RESTful API è®¾è®¡
- CRUD æ“ä½œ

---

## ğŸ’¡ æ ¸å¿ƒçŸ¥è¯†ç‚¹è¯¦è§£

### 1. ç»Ÿä¸€å“åº”æ ¼å¼

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**
- å‰ç«¯å¯ä»¥å†™ç»Ÿä¸€çš„æ‹¦æˆªå™¨å¤„ç†å“åº”
- å‡å°‘å‰ç«¯çš„åˆ¤æ–­é€»è¾‘
- æé«˜å›¢é˜Ÿåä½œæ•ˆç‡

**å“åº”ç»“æ„ï¼š**
```json
{
  "code": 0,           // 0=æˆåŠŸï¼Œé0=å¤±è´¥
  "message": "success", // æç¤ºä¿¡æ¯
  "data": {}           // å®é™…æ•°æ®
}
```

**å‰ç«¯ä½¿ç”¨ï¼ˆAxios ç¤ºä¾‹ï¼‰ï¼š**
```javascript
axios.interceptors.response.use(
  response => {
    if (response.data.code === 0) {
      return response.data.data;  // è¿”å›å®é™…æ•°æ®
    } else {
      // ç»Ÿä¸€é”™è¯¯æç¤º
      message.error(response.data.message);
      return Promise.reject(response.data);
    }
  }
);
```

### 2. é”™è¯¯ç ä½“ç³»

**è®¾è®¡è§„èŒƒï¼š**
- `0`ï¼šæˆåŠŸ
- `4xxxx`ï¼šå®¢æˆ·ç«¯é”™è¯¯ï¼ˆç”¨æˆ·è¾“å…¥ã€æƒé™ç­‰ï¼‰
- `5xxxx`ï¼šæœåŠ¡å™¨é”™è¯¯ï¼ˆç³»ç»Ÿå¼‚å¸¸ï¼‰

**é”™è¯¯ç ç¤ºä¾‹ï¼š**
```python
40001: ç”¨æˆ·åå·²å­˜åœ¨
40002: é‚®ç®±å·²å­˜åœ¨
41000: æœªç™»å½•
41001: Token è¿‡æœŸ
50000: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
```

**å‰ç«¯å¤„ç†ï¼š**
```javascript
switch(response.data.code) {
  case 41000: // æœªç™»å½•
  case 41001: // Token è¿‡æœŸ
    router.push('/login');
    break;
  case 40001: // ç”¨æˆ·åå·²å­˜åœ¨
    formErrors.username = 'ç”¨æˆ·åå·²å­˜åœ¨';
    break;
  default:
    message.error(response.data.message);
}
```

### 3. JWT è®¤è¯æµç¨‹

**ç™»å½•æµç¨‹ï¼š**
```
1. ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
2. åç«¯éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
3. éªŒè¯é€šè¿‡ï¼Œç”Ÿæˆ JWT Token
4. è¿”å› Token ç»™å‰ç«¯
5. å‰ç«¯å­˜å‚¨ Tokenï¼ˆlocalStorageï¼‰
```

**è®¿é—®æ¥å£æµç¨‹ï¼š**
```
1. å‰ç«¯åœ¨è¯·æ±‚å¤´æºå¸¦ Token
   Authorization: Bearer <token>
2. åç«¯éªŒè¯ Token
3. Token æœ‰æ•ˆï¼Œè¿”å›æ•°æ®
4. Token æ— æ•ˆ/è¿‡æœŸï¼Œè¿”å› 401 é”™è¯¯
```

**å®‰å…¨æ€§ï¼š**
- Token æœ‰ç­¾åï¼Œæ— æ³•ç¯¡æ”¹
- è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé™ä½é£é™©
- ä¸è¦åœ¨ Token é‡Œå­˜æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ç­‰ï¼‰

### 4. æ•°æ®åº“ ORM

**ORM çš„å¥½å¤„ï¼š**
- ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ“ä½œæ•°æ®åº“
- é˜²æ­¢ SQL æ³¨å…¥
- è·¨æ•°æ®åº“ï¼ˆSQLiteã€PostgreSQLã€MySQLï¼‰

**ç¤ºä¾‹å¯¹æ¯”ï¼š**

âŒ åŸç”Ÿ SQLï¼ˆä¸æ¨èï¼‰ï¼š
```python
cursor.execute("SELECT * FROM users WHERE username = ?", (username,))
```

âœ… ORMï¼ˆæ¨èï¼‰ï¼š
```python
user = await db.execute(select(User).where(User.username == username))
```

### 5. ä¾èµ–æ³¨å…¥

**ä¸ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼š**
```python
@router.get("/users/me")
async def get_me(request: Request):
    token = request.headers.get("Authorization")
    user_id = parse_token(token)
    db = get_database()
    user = db.query(User).filter(User.id == user_id).first()
    return user
```

**ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼š**
```python
@router.get("/users/me")
async def get_me(current_user: User = Depends(get_current_user)):
    return current_user  # FastAPI è‡ªåŠ¨å¤„ç†æ‰€æœ‰é€»è¾‘
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ·»åŠ æ–°çš„ API æ¥å£ï¼Ÿ

1. åœ¨ `api/v1/` åˆ›å»ºæ–°çš„è·¯ç”±æ–‡ä»¶
2. å®šä¹‰è·¯ç”±å‡½æ•°
3. åœ¨ `main.py` ä¸­æ³¨å†Œè·¯ç”±

### Q2: å¦‚ä½•æ·»åŠ æ–°çš„æ•°æ®è¡¨ï¼Ÿ

1. åœ¨ `models/` åˆ›å»ºæ¨¡å‹ç±»
2. åœ¨ `schemas/` åˆ›å»ºå¯¹åº”çš„ Pydantic æ¨¡å‹
3. è¿è¡Œåº”ç”¨ï¼Œè¡¨ä¼šè‡ªåŠ¨åˆ›å»ºï¼ˆæˆ–ä½¿ç”¨ Alembic è¿ç§»ï¼‰

### Q3: å¦‚ä½•ä¿®æ”¹ Token è¿‡æœŸæ—¶é—´ï¼Ÿ

ä¿®æ”¹ `.env` æ–‡ä»¶ä¸­çš„ `ACCESS_TOKEN_EXPIRE_MINUTES`

### Q4: å¦‚ä½•éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ

1. ä¿®æ”¹ `.env` æ–‡ä»¶ï¼ˆDEBUG=False, ä¿®æ”¹ SECRET_KEYï¼‰
2. ä½¿ç”¨ PostgreSQL æ›¿ä»£ SQLite
3. ä½¿ç”¨ Gunicorn + Uvicorn Workers
4. é…ç½® Nginx åå‘ä»£ç†

---

## ğŸ“ å¾…å®Œå–„åŠŸèƒ½ï¼ˆç»ƒä¹ é¡¹ç›®ï¼‰

ä»¥ä¸‹åŠŸèƒ½ä½ å¯ä»¥è‡ªå·±å°è¯•å®ç°ï¼š

- [ ] é‚®ç®±éªŒè¯
- [ ] å¿˜è®°å¯†ç 
- [ ] è§’è‰²å’Œæƒé™ç®¡ç†ï¼ˆRBACï¼‰
- [ ] æ–‡ä»¶ä¸Šä¼ 
- [ ] Refresh Token
- [ ] æ¥å£é™æµ
- [ ] æ•°æ®ç¼“å­˜ï¼ˆRedisï¼‰
- [ ] å•å…ƒæµ‹è¯•
- [ ] Docker éƒ¨ç½²

---

## ğŸ“ å­¦ä¹ å»ºè®®

### å¯¹äºå‰ç«¯å¼€å‘è€…

1. **ç±»æ¯”å­¦ä¹ **ï¼šæ–‡ä»¶ä¸­æœ‰å¤§é‡å‰ç«¯ç±»æ¯”ï¼Œå¸®åŠ©ä½ ç†è§£åç«¯æ¦‚å¿µ
2. **åŠ¨æ‰‹å®è·µ**ï¼šä¸è¦åªçœ‹ä»£ç ï¼Œä¸€å®šè¦è‡ªå·±è¿è¡Œå’Œä¿®æ”¹
3. **é˜…è¯»æ³¨é‡Š**ï¼šæ¯ä¸ªæ–‡ä»¶çš„æ³¨é‡Šéƒ½å¾ˆè¯¦ç»†ï¼Œæ…¢æ…¢è¯»
4. **è°ƒè¯•æŠ€å·§**ï¼šå¤šç”¨ `print()` å’Œæ—¥å¿—æŸ¥çœ‹æ•°æ®æµè½¬

### å­¦ä¹ é¡ºåº

1. å…ˆè¿è¡Œé¡¹ç›®ï¼Œçœ‹æ•ˆæœ
2. é˜…è¯»æ ¸å¿ƒæ–‡ä»¶ï¼ˆæ ‡è®° â­ çš„æ–‡ä»¶ï¼‰
3. å°è¯•æ·»åŠ æ–°åŠŸèƒ½
4. é˜…è¯» FastAPI å®˜æ–¹æ–‡æ¡£

---

## ğŸ“š æ¨èèµ„æº

- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [SQLAlchemy æ–‡æ¡£](https://docs.sqlalchemy.org/)
- [Pydantic æ–‡æ¡£](https://docs.pydantic.dev/)

---

## ğŸ’¬ åé¦ˆå’Œå»ºè®®

å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æ Issueï¼

---

ç¥å­¦ä¹ æ„‰å¿«ï¼ğŸ‰
